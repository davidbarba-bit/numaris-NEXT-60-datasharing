<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Next - Data Sharing Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>
  <script src="https://unpkg.com/antd@5.20.6/dist/antd.min.js"></script>
  <script src="https://unpkg.com/@ant-design/icons@5.2.6/dist/index.umd.min.js"></script>
  <style>
    :root { --primary: #1867FF; --primary-dark: #2f54eb; --text-primary: #3F3F3F; --text-secondary: #666666; --bg-page: #f0f2f5; --bg-header: #FAFAFA; --border-light: #f0f0f0; --success: #52c41a; --warning: #faad14; --error: #ff4d4f; }
    * { font-family: "Source Sans 3", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; background: var(--bg-page); color: var(--text-primary); }
    .ant-layout-sider { background: var(--bg-header) !important; border-right: 1px solid var(--border-light); }
    .ant-menu-light { background: transparent !important; }
    .ant-menu-light .ant-menu-item-selected { background-color: var(--bg-page) !important; font-weight: 600; }
    .ant-layout-header { background: #fff !important; border-bottom: 1px solid var(--border-light); padding: 0 24px !important; height: 64px !important; }
    .ant-card { border-radius: 12px; }
    .ant-btn-primary { background: var(--primary-dark) !important; border-color: var(--primary-dark) !important; }
    .logo-container { height: 64px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border-light); }
    .logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
    .integration-card { cursor: pointer; } .integration-card:hover { border-color: var(--primary); }
    code { background: var(--bg-header); padding: 2px 8px; border-radius: 4px; font-size: 12px; border: 1px solid var(--border-light); font-family: 'SF Mono', Monaco, monospace; }
    .empty-state { text-align: center; padding: 60px 20px; }
    .code-block { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; overflow-x: auto; }
    .masked-token { font-family: 'SF Mono', Monaco, monospace; letter-spacing: 2px; }
  </style>
</head>
<body>
<div id="root"></div>
<script>
var e = React.createElement, useState = React.useState, useEffect = React.useEffect;
var Layout = antd.Layout, Menu = antd.Menu, Button = antd.Button, Card = antd.Card, Table = antd.Table, Tag = antd.Tag, Space = antd.Space, Typography = antd.Typography, Statistic = antd.Statistic, Modal = antd.Modal, Form = antd.Form, Input = antd.Input, Select = antd.Select, Checkbox = antd.Checkbox, Switch = antd.Switch, Tooltip = antd.Tooltip, Breadcrumb = antd.Breadcrumb, Row = antd.Row, Col = antd.Col, Alert = antd.Alert, message = antd.message, ConfigProvider = antd.ConfigProvider, Popconfirm = antd.Popconfirm, Divider = antd.Divider, Tabs = antd.Tabs, Spin = antd.Spin, Result = antd.Result;
var Header = Layout.Header, Sider = Layout.Sider, Content = Layout.Content;
var Title = Typography.Title, Text = Typography.Text, Paragraph = Typography.Paragraph;
var HomeOutlined = icons.HomeOutlined, KeyOutlined = icons.KeyOutlined, ShareAltOutlined = icons.ShareAltOutlined, ApiOutlined = icons.ApiOutlined, HistoryOutlined = icons.HistoryOutlined, BookOutlined = icons.BookOutlined, CodeOutlined = icons.CodeOutlined, PlusOutlined = icons.PlusOutlined, QuestionCircleOutlined = icons.QuestionCircleOutlined, SettingOutlined = icons.SettingOutlined, DeleteOutlined = icons.DeleteOutlined, PlayCircleOutlined = icons.PlayCircleOutlined, CopyOutlined = icons.CopyOutlined, CheckCircleOutlined = icons.CheckCircleOutlined, CloseCircleOutlined = icons.CloseCircleOutlined, DownloadOutlined = icons.DownloadOutlined, SlackOutlined = icons.SlackOutlined, DatabaseOutlined = icons.DatabaseOutlined, BankOutlined = icons.BankOutlined, BoxPlotOutlined = icons.BoxPlotOutlined, NodeIndexOutlined = icons.NodeIndexOutlined, SafetyCertificateOutlined = icons.SafetyCertificateOutlined, CloudServerOutlined = icons.CloudServerOutlined, ReloadOutlined = icons.ReloadOutlined, LockOutlined = icons.LockOutlined, SendOutlined = icons.SendOutlined, LinkOutlined = icons.LinkOutlined, FileTextOutlined = icons.FileTextOutlined, GithubOutlined = icons.GithubOutlined, EyeOutlined = icons.EyeOutlined, EyeInvisibleOutlined = icons.EyeInvisibleOutlined, LoadingOutlined = icons.LoadingOutlined;

var theme = { token: { colorPrimary: '#1867FF', colorText: '#3F3F3F', fontFamily: '"Source Sans 3", sans-serif', borderRadius: 8 } };

var mockGroups = [{ value: 'cdmx', label: 'Entregas CDMX' }, { value: 'gdl', label: 'Entregas GDL' }, { value: 'mty', label: 'Distribuci√≥n MTY' }, { value: 'corp', label: 'Corporativos' }];
var mockUnits = [{ value: 'u1', label: 'TRK-001 (Volvo FH)' }, { value: 'u2', label: 'TRK-002 (Kenworth T680)' }, { value: 'u3', label: 'VAN-015 (Mercedes Sprinter)' }, { value: 'u4', label: 'VAN-016 (Ford Transit)' }, { value: 'u5', label: 'CAR-101 (Toyota Hilux)' }];

var apiKeysData = [
  { key: '1', name: 'Dashboard Power BI', token: 'nxt_a8f3kx7k2m9n4p5q', fullToken: 'nxt_a8f3kx7k2m9n4p5q6r7s8t9u0v1w2x3y4z', permissions: ['read:units', 'read:positions', 'read:events'], scope: 'Todas las unidades', scopeType: 'all', lastUsed: 'hace 5 min' },
  { key: '2', name: 'App M√≥vil Cliente', token: 'nxt_b2c9m4n8j6k3l7p2', fullToken: 'nxt_b2c9m4n8j6k3l7p2q4r5s6t7u8v9w0x1y2z', permissions: ['read:positions'], scope: 'Grupo: Entregas CDMX', scopeType: 'group', scopeValue: 'cdmx', lastUsed: 'hace 1 hora' }
];
var webhooksOutData = [
  { key: '1', name: 'Alertas Cr√≠ticas ‚Üí Slack', url: 'https://hooks.slack.com/services/T0.../B0...', events: ['panic_button', 'speeding'], delivered: 1247, failed: 3, lastSent: 'hace 2 min', active: true, hmac: true, retries: 3, filterType: 'all' },
  { key: '2', name: 'Posiciones ‚Üí Data Warehouse', url: 'https://api.warehouse.acme.com/ingest', events: ['position_update'], delivered: 45821, failed: 12, lastSent: 'hace 30 seg', active: true, hmac: true, retries: 5, filterType: 'group', filterValue: 'cdmx' }
];
var webhooksInData = [
  { key: '1', name: '√ìrdenes ‚Üê ERP SAP', endpoint: 'https://api.next.numaris.com/webhook/in/ord_8f3k2...', secret: 'whsec_abc123def456ghi789', fullSecret: 'whsec_abc123def456ghi789jkl012mno345pqr', received: 2341, linkBy: 'Placa', lastReceived: 'hace 15 min', active: true },
  { key: '2', name: 'Rutas ‚Üê TMS', endpoint: 'https://api.next.numaris.com/webhook/in/rut_2m8x9...', secret: 'whsec_def456uvw789xyz012', fullSecret: 'whsec_def456uvw789xyz012abc345def678ghi', received: 456, linkBy: 'Georutas', lastReceived: 'hace 2 horas', active: true }
];
var logsData = [
  { key: '1', timestamp: '2026-02-01 22:45:12', type: 'Webhook Out', typeColor: 'green', typeKey: 'webhook-out', desc: 'panic_button ‚Üí Slack', status: 200, latency: '145ms' },
  { key: '2', timestamp: '2026-02-01 22:44:58', type: 'API', typeColor: 'blue', typeKey: 'api', desc: 'GET /units/positions', status: 200, latency: '89ms' },
  { key: '3', timestamp: '2026-02-01 22:44:32', type: 'Webhook In', typeColor: 'purple', typeKey: 'webhook-in', desc: 'Orden #12847 de SAP', status: 200, latency: '234ms' },
  { key: '4', timestamp: '2026-02-01 22:43:15', type: 'Webhook Out', typeColor: 'green', typeKey: 'webhook-out', desc: 'position_update ‚Üí DW', status: 200, latency: '67ms' },
  { key: '5', timestamp: '2026-02-01 22:41:08', type: 'Webhook Out', typeColor: 'green', typeKey: 'webhook-out', desc: 'zone_exit ‚Üí ERP SAP', status: 503, latency: '30012ms', error: true }
];

// Componente para mostrar/ocultar tokens (FIX #1)
function TokenDisplay(props) {
  var _visible = useState(false), visible = _visible[0], setVisible = _visible[1];
  var masked = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  var token = props.token || '';
  var fullToken = props.fullToken || token;
  
  function handleCopy() {
    navigator.clipboard.writeText(fullToken).then(function() {
      message.success('Token copiado al portapapeles');
    });
  }
  
  function toggleVisibility() {
    setVisible(!visible);
    if (!visible) {
      // Auto-hide after 5 seconds
      setTimeout(function() { setVisible(false); }, 5000);
    }
  }
  
  return e('div', {style:{display:'flex',alignItems:'center',gap:4}},
    e('code', {className:'masked-token', 'aria-label': props.label || 'Token'}, visible ? fullToken : masked),
    e(Tooltip, {title: visible ? 'Ocultar' : 'Mostrar'},
      e(Button, {type:'text', size:'small', icon: e(visible ? EyeInvisibleOutlined : EyeOutlined), onClick: toggleVisibility, 'aria-label': visible ? 'Ocultar token' : 'Mostrar token'})
    ),
    e(Tooltip, {title:'Copiar'},
      e(Button, {type:'text', size:'small', icon: e(CopyOutlined), onClick: handleCopy, 'aria-label': 'Copiar token'})
    )
  );
}

function App() {
  var _s = function(v) { return useState(v); };
  var _tab = _s('overview'), activeTab = _tab[0], setActiveTab = _tab[1];
  var _modal = _s(null), modalOpen = _modal[0], setModalOpen = _modal[1];
  var _keys = _s(apiKeysData), keys = _keys[0], setKeys = _keys[1];
  var _whOut = _s(webhooksOutData), whOut = _whOut[0], setWhOut = _whOut[1];
  var _whIn = _s(webhooksInData), whIn = _whIn[0], setWhIn = _whIn[1];
  var _accessType = _s('all'), accessType = _accessType[0], setAccessType = _accessType[1];
  var _filterType = _s('all'), filterType = _filterType[0], setFilterType = _filterType[1];
  var _logFilter = _s('all'), logFilter = _logFilter[0], setLogFilter = _logFilter[1];
  var _timeFilter = _s('24h'), timeFilter = _timeFilter[0], setTimeFilter = _timeFilter[1];
  var _editItem = _s(null), editItem = _editItem[0], setEditItem = _editItem[1];
  var _testWh = _s(null), testWh = _testWh[0], setTestWh = _testWh[1];
  var _testing = _s(false), testing = _testing[0], setTesting = _testing[1];
  var _testResult = _s(null), testResult = _testResult[0], setTestResult = _testResult[1];
  var _connModal = _s(null), connModal = _connModal[0], setConnModal = _connModal[1];
  // FIX #4: Loading states
  var _creating = _s(false), creating = _creating[0], setCreating = _creating[1];

  // Form instances para validaci√≥n real
  var _apiKeyForm = Form.useForm(), apiKeyForm = _apiKeyForm[0];
  var _webhookOutForm = Form.useForm(), webhookOutForm = _webhookOutForm[0];
  var _webhookInForm = Form.useForm(), webhookInForm = _webhookInForm[0];
  var _editApiKeyForm = Form.useForm(), editApiKeyForm = _editApiKeyForm[0];
  var _editWhOutForm = Form.useForm(), editWhOutForm = _editWhOutForm[0];
  var _editWhInForm = Form.useForm(), editWhInForm = _editWhInForm[0];
  var _connForm = Form.useForm(), connForm = _connForm[0];

  function resetForms() {
    setAccessType('all');
    setFilterType('all');
    apiKeyForm.resetFields();
    webhookOutForm.resetFields();
    webhookInForm.resetFields();
  }

  function closeModal() {
    setModalOpen(null);
    setEditItem(null);
    setCreating(false);
    resetForms();
  }

  // Validador HTTPS custom
  function validateHttps(_, value) {
    if (!value) return Promise.reject('La URL es obligatoria');
    if (!value.startsWith('https://')) return Promise.reject('Debe comenzar con https://');
    try { new URL(value); return Promise.resolve(); } 
    catch (e) { return Promise.reject('URL inv√°lida'); }
  }

  var menuItems = [
    { key: 'g1', type: 'group', label: 'Integraciones' },
    { key: 'overview', icon: e(HomeOutlined), label: 'Vista General' },
    { key: 'api-keys', icon: e(KeyOutlined), label: 'API Keys' },
    { key: 'webhooks-out', icon: e(ShareAltOutlined), label: 'Webhooks Salientes' },
    { key: 'webhooks-in', icon: e(ApiOutlined, {style:{transform:'rotate(180deg)'}}), label: 'Webhooks Entrantes' },
    { key: 'connections', icon: e(CloudServerOutlined), label: 'Conexiones' },
    { key: 'logs', icon: e(HistoryOutlined), label: 'Logs' },
    { key: 'g2', type: 'group', label: 'Ayuda' },
    { key: 'docs', icon: e(BookOutlined), label: 'Documentaci√≥n API' },
    { key: 'sdks', icon: e(CodeOutlined), label: 'SDKs' }
  ];

  // FIX #2: Regenerar con confirmaci√≥n
  function handleRegenerateToken(itemKey) {
    var newToken = 'nxt_' + Math.random().toString(36).substr(2, 32);
    setKeys(keys.map(function(k) {
      if (k.key === itemKey) {
        return Object.assign({}, k, { token: newToken.substr(0, 20), fullToken: newToken });
      }
      return k;
    }));
    Modal.success({
      title: 'Token Regenerado',
      content: e('div', null,
        e(Alert, {type:'warning', message:'Guarda este token ahora. No se mostrar√° de nuevo.', style:{marginBottom:16}}),
        e('code', {style:{display:'block',padding:12,background:'#f5f5f5',borderRadius:4,wordBreak:'break-all'}}, newToken)
      )
    });
  }

  function renderApiKeys() {
    if (!keys.length) return e('div', {className:'empty-state'}, e(KeyOutlined, {style:{fontSize:48,color:'#d9d9d9'}}), e(Title, {level:4,style:{color:'#8c8c8c'}}, 'No hay API Keys'), e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('api-key');resetForms();}, 'aria-label':'Crear nueva API Key'}, 'Crear API Key'));
    return e('div', null,
      e('div', {style:{marginBottom:24,display:'flex',justifyContent:'space-between'}},
        e('div', null, e(Title, {level:4,style:{margin:0}}, 'API Keys'), e(Text, {type:'secondary'}, 'Tokens de acceso para aplicaciones externas')),
        e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('api-key');resetForms();}, 'aria-label':'Crear nueva API Key'}, 'Nueva API Key')
      ),
      e(Space, {direction:'vertical', style:{width:'100%'}, size:16}, keys.map(function(item) {
        return e(Card, {key:item.key},
          e('div', {style:{display:'flex',justifyContent:'space-between'}},
            e(Space, {align:'start'},
              e('div', {style:{width:40,height:40,background:'#e6f4ff',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center'}, 'aria-hidden':'true'}, e(KeyOutlined, {style:{color:'#1867FF'}})),
              e('div', null,
                e(Space, null, e(Text, {strong:true}, item.name), e(Tag, {color:'success'}, 'Activa')),
                // FIX #1: Token enmascarado por defecto
                e('div', {style:{marginTop:8}}, e(TokenDisplay, {token:item.token, fullToken:item.fullToken, label:'API Key de ' + item.name})),
                e('div', {style:{marginTop:8}}, item.permissions.map(function(p){return e(Tag,{key:p,color:'blue'},p);})),
                e(Text, {type:'secondary',style:{fontSize:12}}, item.scope + ' ‚Ä¢ √öltimo: ' + item.lastUsed)
              )
            ),
            e(Space, null,
              // FIX #2: Popconfirm al regenerar
              e(Popconfirm, {
                title:'¬øRegenerar token?',
                description:'El token actual dejar√° de funcionar inmediatamente. Las integraciones activas se interrumpir√°n.',
                onConfirm:function(){handleRegenerateToken(item.key);},
                okText:'Regenerar',
                cancelText:'Cancelar',
                okButtonProps:{danger:true}
              }, e(Tooltip, {title:'Regenerar'}, e(Button, {icon:e(ReloadOutlined), 'aria-label':'Regenerar token'}))),
              e(Tooltip, {title:'Configurar'}, e(Button, {icon:e(SettingOutlined), onClick:function(){setEditItem(item);setAccessType(item.scopeType||'all');editApiKeyForm.setFieldsValue({name:item.name,accessType:item.scopeType||'all',group:item.scopeValue});setModalOpen('edit-api-key');}, 'aria-label':'Configurar API Key'})),
              e(Popconfirm, {title:'¬øEliminar?',description:'Esta acci√≥n no se puede deshacer.',onConfirm:function(){setKeys(keys.filter(function(k){return k.key!==item.key;}));message.success('Eliminada');}}, e(Button, {icon:e(DeleteOutlined),danger:true, 'aria-label':'Eliminar API Key'}))
            )
          )
        );
      }))
    );
  }

  function renderWebhooksOut() {
    if (!whOut.length) return e('div', {className:'empty-state'}, e(ShareAltOutlined, {style:{fontSize:48,color:'#d9d9d9'}}), e(Title, {level:4,style:{color:'#8c8c8c'}}, 'No hay Webhooks'), e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('webhook-out');resetForms();}, 'aria-label':'Crear webhook saliente'}, 'Crear Webhook'));
    var iconMap = {'1':SlackOutlined,'2':DatabaseOutlined,'3':BankOutlined};
    return e('div', null,
      e('div', {style:{marginBottom:24,display:'flex',justifyContent:'space-between'}},
        e('div', null, e(Title, {level:4,style:{margin:0}}, 'Webhooks Salientes'), e(Text, {type:'secondary'}, 'Env√≠a eventos a sistemas externos')),
        e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('webhook-out');resetForms();}, 'aria-label':'Crear webhook saliente'}, 'Nuevo Webhook')
      ),
      e(Space, {direction:'vertical', style:{width:'100%'}, size:16}, whOut.map(function(item) {
        var Icon = iconMap[item.key] || DatabaseOutlined;
        return e(Card, {key:item.key},
          e('div', {style:{display:'flex',justifyContent:'space-between'}},
            e(Space, {align:'start'},
              e('div', {style:{width:40,height:40,background:'#f6ffed',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center'}, 'aria-hidden':'true'}, e(Icon, {style:{color:'#52c41a'}})),
              e('div', null,
                e(Space, null, e(Text, {strong:true}, item.name), item.hmac && e(Tag, {color:'green',icon:e(LockOutlined)}, 'HMAC'), e(Tag, null, item.retries + ' reintentos')),
                e('code', {style:{fontSize:11}}, item.url),
                e('div', {style:{marginTop:8}}, item.events.map(function(ev){return e(Tag,{key:ev,color:ev.includes('panic')?'red':'blue'},ev);})),
                e(Space, {style:{marginTop:4}}, e(Text, {type:'success',style:{fontSize:12}}, '‚úì '+item.delivered+' entregados'), e(Text, {type:item.failed?'danger':'secondary',style:{fontSize:12}}, '‚úó '+item.failed+' fallidos'))
              )
            ),
            e(Space, null,
              e(Switch, {defaultChecked:item.active, 'aria-label':'Activar/desactivar webhook', onChange:function(checked){message.success(checked ? 'Webhook activado' : 'Webhook desactivado');}}),
              e(Tooltip, {title:'Probar'}, e(Button, {icon:e(PlayCircleOutlined), onClick:function(){setTestWh(item);setTestResult(null);setModalOpen('test-webhook');}, 'aria-label':'Probar webhook'})),
              e(Tooltip, {title:'Configurar'}, e(Button, {icon:e(SettingOutlined), onClick:function(){setEditItem(item);setFilterType(item.filterType||'all');editWhOutForm.setFieldsValue({name:item.name,url:item.url,filterType:item.filterType||'all',group:item.filterValue});setModalOpen('edit-webhook-out');}, 'aria-label':'Configurar webhook'})),
              e(Popconfirm, {title:'¬øEliminar?',description:'Esta acci√≥n no se puede deshacer.',onConfirm:function(){setWhOut(whOut.filter(function(w){return w.key!==item.key;}));message.success('Eliminado');}}, e(Button, {icon:e(DeleteOutlined),danger:true, 'aria-label':'Eliminar webhook'}))
            )
          )
        );
      }))
    );
  }

  function renderWebhooksIn() {
    if (!whIn.length) return e('div', {className:'empty-state'}, e(ApiOutlined, {style:{fontSize:48,color:'#d9d9d9'}}), e(Title, {level:4,style:{color:'#8c8c8c'}}, 'No hay Endpoints'), e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('webhook-in');resetForms();}, 'aria-label':'Crear endpoint entrante'}, 'Crear Endpoint'));
    return e('div', null,
      e('div', {style:{marginBottom:24,display:'flex',justifyContent:'space-between'}},
        e('div', null, e(Title, {level:4,style:{margin:0}}, 'Webhooks Entrantes'), e(Text, {type:'secondary'}, 'Recibe datos de sistemas externos')),
        e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('webhook-in');resetForms();}, 'aria-label':'Crear endpoint entrante'}, 'Nuevo Endpoint')
      ),
      e(Alert, {message:'Los datos recibidos se vinculan autom√°ticamente con tus unidades.', type:'info', showIcon:true, style:{marginBottom:16}}),
      e(Space, {direction:'vertical', style:{width:'100%'}, size:16}, whIn.map(function(item) {
        return e(Card, {key:item.key},
          e('div', {style:{display:'flex',justifyContent:'space-between'}},
            e(Space, {align:'start'},
              e('div', {style:{width:40,height:40,background:'#fffbe6',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center'}, 'aria-hidden':'true'}, e(BoxPlotOutlined, {style:{color:'#faad14'}})),
              e('div', null,
                e(Text, {strong:true}, item.name),
                e('div', {style:{marginTop:8}}, e(Text, {type:'secondary',style:{fontSize:12}}, 'Endpoint: '), e('code', {style:{fontSize:11}}, item.endpoint), e(Button, {type:'text',size:'small',icon:e(CopyOutlined),onClick:function(){message.success('Endpoint copiado');}, 'aria-label':'Copiar endpoint'})),
                // FIX #1: Secret enmascarado
                e('div', {style:{marginTop:4,padding:8,background:'#f5f5f5',borderRadius:4}}, 
                  e(Text, {type:'secondary',style:{fontSize:12}}, 'Secreto: '),
                  e(TokenDisplay, {token:item.secret, fullToken:item.fullSecret, label:'Secreto de webhook'}),
                  // FIX #2: Popconfirm al regenerar secreto
                  e(Popconfirm, {
                    title:'¬øRegenerar secreto?',
                    description:'El secreto actual dejar√° de funcionar. Deber√°s actualizar la configuraci√≥n en el sistema origen.',
                    onConfirm:function(){message.success('Secreto regenerado');},
                    okText:'Regenerar',
                    cancelText:'Cancelar'
                  }, e(Button, {type:'text',size:'small',icon:e(ReloadOutlined), 'aria-label':'Regenerar secreto'}))
                ),
                e(Text, {type:'secondary',style:{fontSize:12}}, item.received + ' recibidos ‚Ä¢ ' + item.linkBy + ' ‚Ä¢ ' + item.lastReceived)
              )
            ),
            e(Space, null,
              e(Switch, {defaultChecked:item.active, 'aria-label':'Activar/desactivar endpoint', onChange:function(checked){message.success(checked ? 'Endpoint activado' : 'Endpoint desactivado');}}),
              e(Tooltip, {title:'Configurar'}, e(Button, {icon:e(SettingOutlined), onClick:function(){setEditItem(item);editWhInForm.setFieldsValue({name:item.name,linkBy:item.linkBy==='Placa'?'plate':'other'});setModalOpen('edit-webhook-in');}, 'aria-label':'Configurar endpoint'})),
              e(Popconfirm, {title:'¬øEliminar?',description:'Esta acci√≥n no se puede deshacer.',onConfirm:function(){setWhIn(whIn.filter(function(w){return w.key!==item.key;}));message.success('Eliminado');}}, e(Button, {icon:e(DeleteOutlined),danger:true, 'aria-label':'Eliminar endpoint'}))
            )
          )
        );
      }))
    );
  }

  function renderLogs() {
    var filtered = logsData.filter(function(l) { return logFilter === 'all' || l.typeKey === logFilter; });
    var cols = [
      {title:'Timestamp', dataIndex:'timestamp', width:180},
      {title:'Tipo', dataIndex:'type', width:120, render:function(t,r){return e(Tag,{color:r.typeColor},t);}},
      {title:'Descripci√≥n', dataIndex:'desc'},
      {title:'Estado', dataIndex:'status', width:80, render:function(s){return s===200 ? e(Text,{type:'success'},'‚úì '+s) : e(Text,{type:'danger'},'‚úó '+s);}},
      {title:'Latencia', dataIndex:'latency', width:100}
    ];
    return e('div', null,
      e('div', {style:{marginBottom:24,display:'flex',justifyContent:'space-between'}},
        e('div', null, e(Title, {level:4,style:{margin:0}}, 'Logs'), e(Text, {type:'secondary'}, 'Historial de operaciones')),
        e(Space, null,
          e(Select, {value:logFilter, onChange:setLogFilter, style:{width:160}, options:[{value:'all',label:'Todos'},{value:'api',label:'API'},{value:'webhook-out',label:'Webhooks Out'},{value:'webhook-in',label:'Webhooks In'}], 'aria-label':'Filtrar por tipo'}),
          e(Select, {value:timeFilter, onChange:setTimeFilter, style:{width:140}, options:[{value:'1h',label:'√öltima hora'},{value:'24h',label:'24 horas'},{value:'7d',label:'7 d√≠as'}], 'aria-label':'Filtrar por tiempo'})
        )
      ),
      e(Card, {bodyStyle:{padding:0}}, e(Table, {columns:cols, dataSource:filtered, pagination:{pageSize:10}}))
    );
  }

  function renderConnections() {
    var conns = [
      {key:'slack', name:'Slack', desc:'Alertas a canales', icon:SlackOutlined, color:'#722ed1', connected:true},
      {key:'teams', name:'Microsoft Teams', desc:'Notificaciones', icon:SafetyCertificateOutlined, color:'#5558af', connected:false},
      {key:'sap', name:'SAP ERP', desc:'Sincroniza entregas', icon:BankOutlined, color:'#0070f2', connected:true},
      {key:'salesforce', name:'Salesforce', desc:'Vincula con CRM', icon:CloudServerOutlined, color:'#00a1e0', connected:false},
      {key:'sheets', name:'Google Sheets', desc:'Exporta datos', icon:DatabaseOutlined, color:'#0f9d58', connected:false}
    ];
    return e('div', null,
      e('div', {style:{marginBottom:24}}, e(Title, {level:4,style:{margin:0}}, 'Conexiones'), e(Text, {type:'secondary'}, 'Integraciones pre-configuradas')),
      e(Row, {gutter:[16,16]},
        conns.map(function(c) {
          return e(Col, {span:8, key:c.key}, e(Card, {style:c.connected?{border:'2px solid #52c41a'}:{}},
            e('div', {style:{display:'flex',justifyContent:'space-between',marginBottom:16}},
              e('div', {style:{width:40,height:40,background:c.color+'15',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center',color:c.color}, 'aria-hidden':'true'}, e(c.icon)),
              c.connected && e(Tag, {color:'success'}, 'Conectado')
            ),
            e(Title, {level:5,style:{margin:0}}, c.name),
            e(Text, {type:'secondary'}, c.desc),
            e(Button, {block:true, style:{marginTop:16}, type:c.connected?'default':'primary', onClick:function(){setConnModal(c);connForm.resetFields();}, 'aria-label':(c.connected ? 'Configurar ' : 'Conectar ') + c.name}, c.connected ? 'Configurar' : 'Conectar')
          ));
        }),
        e(Col, {span:8}, e(Card, {style:{border:'2px dashed #d9d9d9'}},
          e('div', {style:{width:40,height:40,background:'#fafafa',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center',marginBottom:16}, 'aria-hidden':'true'}, e(CodeOutlined, {style:{color:'#8c8c8c'}})),
          e(Title, {level:5,style:{margin:0}}, 'Custom'),
          e(Text, {type:'secondary'}, 'Usa la API'),
          e(Button, {block:true, style:{marginTop:16}, onClick:function(){setActiveTab('docs');}, 'aria-label':'Ver documentaci√≥n de API'}, 'Ver Docs')
        ))
      )
    );
  }

  function renderDocs() {
    return e('div', null,
      e(Title, {level:4}, 'Documentaci√≥n API'),
      e(Tabs, {items:[
        {key:'auth', label:'Autenticaci√≥n', children:e('div', null,
          e(Paragraph, null, 'Todas las requests requieren un header de autorizaci√≥n:'),
          e('pre', {className:'code-block', 'aria-label':'Ejemplo de header de autorizaci√≥n'}, 'Authorization: Bearer sk_live_your_api_key'),
          e(Paragraph, null, 'Las API Keys se pueden crear desde la secci√≥n "API Keys".'))},
        {key:'units', label:'Unidades', children:e('div', null,
          e(Title, {level:5}, 'GET /api/v1/units'),
          e(Paragraph, null, 'Obtiene la lista de unidades.'),
          e('pre', {className:'code-block', 'aria-label':'Ejemplo de request GET units'}, 'curl -H "Authorization: Bearer sk_live_xxx" \\\n  https://api.next.numaris.com/api/v1/units'),
          e(Title, {level:5,style:{marginTop:24}}, 'GET /api/v1/units/:id/position'),
          e(Paragraph, null, 'Obtiene la posici√≥n actual de una unidad.'))},
        {key:'events', label:'Eventos', children:e('div', null,
          e(Title, {level:5}, 'GET /api/v1/events'),
          e(Paragraph, null, 'Obtiene eventos con filtros opcionales.'),
          e('pre', {className:'code-block', 'aria-label':'Ejemplo de request GET events'}, 'GET /api/v1/events?type=panic_button&from=2026-02-01'))},
        {key:'webhooks', label:'Webhooks', children:e('div', null,
          e(Title, {level:5}, 'Verificaci√≥n HMAC'),
          e(Paragraph, null, 'Los webhooks incluyen firma en el header X-Next-Signature:'),
          e('pre', {className:'code-block', 'aria-label':'Ejemplo de verificaci√≥n HMAC'}, 'const crypto = require("crypto");\nconst sig = crypto.createHmac("sha256", secret)\n  .update(body).digest("hex");\nif (sig === headerSig) { /* v√°lido */ }'))}
      ]})
    );
  }

  function renderSDKs() {
    var sdks = [
      {lang:'JavaScript/Node.js', icon:'üì¶', pkg:'npm install @numaris/next-sdk', repo:'github.com/numaris/next-sdk-js'},
      {lang:'Python', icon:'üêç', pkg:'pip install numaris-next', repo:'github.com/numaris/next-sdk-python'},
      {lang:'PHP', icon:'üêò', pkg:'composer require numaris/next-sdk', repo:'github.com/numaris/next-sdk-php'},
      {lang:'Go', icon:'üîµ', pkg:'go get github.com/numaris/next-sdk-go', repo:'github.com/numaris/next-sdk-go'}
    ];
    return e('div', null,
      e(Title, {level:4}, 'SDKs Oficiales'),
      e(Paragraph, null, 'Bibliotecas para integrar f√°cilmente con Next.'),
      e(Row, {gutter:[16,16]}, sdks.map(function(s) {
        return e(Col, {span:12, key:s.lang}, e(Card, null,
          e(Space, null, e('span', {style:{fontSize:24}, 'aria-hidden':'true'}, s.icon), e(Title, {level:5,style:{margin:0}}, s.lang)),
          e('pre', {style:{background:'#f5f5f5',padding:8,borderRadius:4,marginTop:12,fontSize:12}, 'aria-label':'Comando de instalaci√≥n'}, s.pkg),
          e(Button, {type:'link', icon:e(GithubOutlined), style:{padding:0,marginTop:8}, 'aria-label':'Ver repositorio en GitHub'}, s.repo)
        ));
      }))
    );
  }

  function renderOverview() {
    return e('div', null,
      e(Row, {gutter:[16,16], style:{marginBottom:24}},
        e(Col, {span:6}, e(Card, {className:'stat-card'}, e(Statistic, {title:'API Requests (24h)', value:12847}), e(Text, {type:'success',style:{fontSize:12}}, '‚Üë 12%'))),
        e(Col, {span:6}, e(Card, {className:'stat-card'}, e(Statistic, {title:'Webhooks Enviados', value:3421}), e(Text, {type:'success',style:{fontSize:12}}, '99.2% OK'))),
        e(Col, {span:6}, e(Card, {className:'stat-card'}, e(Statistic, {title:'Datos Recibidos', value:847}))),
        e(Col, {span:6}, e(Card, {className:'stat-card'}, e(Statistic, {title:'Integraciones', value:8})))
      ),
      e(Row, {gutter:[16,16], style:{marginBottom:24}},
        e(Col, {span:8}, e(Card, {className:'integration-card', style:{borderLeft:'4px solid #1867FF'}, onClick:function(){setActiveTab('api-keys');}, role:'button', tabIndex:0, 'aria-label':'Ir a API Keys'}, e(Space, null, e(KeyOutlined, {style:{fontSize:24,color:'#1867FF'}, 'aria-hidden':'true'}), e('div', null, e(Title, {level:5,style:{margin:0}}, 'API Keys'), e(Text, {type:'secondary'}, keys.length + ' activas'))))),
        e(Col, {span:8}, e(Card, {className:'integration-card', style:{borderLeft:'4px solid #52c41a'}, onClick:function(){setActiveTab('webhooks-out');}, role:'button', tabIndex:0, 'aria-label':'Ir a Webhooks Salientes'}, e(Space, null, e(ShareAltOutlined, {style:{fontSize:24,color:'#52c41a'}, 'aria-hidden':'true'}), e('div', null, e(Title, {level:5,style:{margin:0}}, 'Webhooks Out'), e(Text, {type:'secondary'}, whOut.length + ' activos'))))),
        e(Col, {span:8}, e(Card, {className:'integration-card', style:{borderLeft:'4px solid #722ed1'}, onClick:function(){setActiveTab('webhooks-in');}, role:'button', tabIndex:0, 'aria-label':'Ir a Webhooks Entrantes'}, e(Space, null, e(ApiOutlined, {style:{fontSize:24,color:'#722ed1',transform:'rotate(180deg)'}, 'aria-hidden':'true'}), e('div', null, e(Title, {level:5,style:{margin:0}}, 'Webhooks In'), e(Text, {type:'secondary'}, whIn.length + ' endpoints')))))
      )
    );
  }

  function renderContent() {
    switch(activeTab) {
      case 'api-keys': return renderApiKeys();
      case 'webhooks-out': return renderWebhooksOut();
      case 'webhooks-in': return renderWebhooksIn();
      case 'logs': return renderLogs();
      case 'connections': return renderConnections();
      case 'docs': return renderDocs();
      case 'sdks': return renderSDKs();
      default: return renderOverview();
    }
  }

  // ===== HANDLERS CON VALIDACI√ìN Y LOADING (FIX #4) =====
  function handleCreateApiKey() {
    apiKeyForm.validateFields().then(function(values) {
      setCreating(true);
      // Simular latencia de API
      setTimeout(function() {
        setCreating(false);
        message.success('API Key "' + values.name + '" creada exitosamente');
        closeModal();
      }, 1500);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleCreateWebhookOut() {
    webhookOutForm.validateFields().then(function(values) {
      setCreating(true);
      setTimeout(function() {
        setCreating(false);
        message.success('Webhook "' + values.name + '" creado exitosamente');
        closeModal();
      }, 1500);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleCreateWebhookIn() {
    webhookInForm.validateFields().then(function(values) {
      setCreating(true);
      setTimeout(function() {
        setCreating(false);
        message.success('Endpoint "' + values.name + '" creado exitosamente');
        closeModal();
      }, 1500);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleEditApiKey() {
    editApiKeyForm.validateFields().then(function(values) {
      setCreating(true);
      setTimeout(function() {
        setCreating(false);
        message.success('API Key actualizada');
        closeModal();
      }, 1000);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleEditWebhookOut() {
    editWhOutForm.validateFields().then(function(values) {
      setCreating(true);
      setTimeout(function() {
        setCreating(false);
        message.success('Webhook actualizado');
        closeModal();
      }, 1000);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleEditWebhookIn() {
    editWhInForm.validateFields().then(function(values) {
      setCreating(true);
      setTimeout(function() {
        setCreating(false);
        message.success('Endpoint actualizado');
        closeModal();
      }, 1000);
    }).catch(function(err) {
      console.log('Validaci√≥n fallida:', err);
    });
  }

  function handleConnection() {
    if (connModal && connModal.connected) {
      connForm.validateFields().then(function(values) {
        setCreating(true);
        setTimeout(function() {
          setCreating(false);
          message.success('Configuraci√≥n guardada');
          setConnModal(null);
        }, 1000);
      }).catch(function(err) {
        console.log('Validaci√≥n fallida:', err);
      });
    } else {
      message.success('Redirigiendo a ' + (connModal ? connModal.name : '') + '...');
      setConnModal(null);
    }
  }

  return e(ConfigProvider, {theme:theme},
    e(Layout, {style:{minHeight:'100vh'}},
      e(Sider, {width:250, theme:'light'},
        e('div', {className:'logo-container'}, e('div', {className:'logo-icon', 'aria-hidden':'true'}, e(ShareAltOutlined)), e('span', {style:{marginLeft:12,fontWeight:600}}, 'Numaris Next')),
        e(Menu, {mode:'inline', selectedKeys:[activeTab], onClick:function(i){setActiveTab(i.key);}, items:menuItems, style:{borderRight:0,paddingTop:8}})
      ),
      e(Layout, null,
        e(Header, {style:{display:'flex',alignItems:'center',justifyContent:'space-between'}},
          e(Breadcrumb, {items:[{title:'Configuraci√≥n'},{title:'Data Sharing'}]}),
          e(Button, {type:'primary', icon:e(PlusOutlined), onClick:function(){setModalOpen('new');}, 'aria-label':'Crear nueva integraci√≥n'}, 'Nueva Integraci√≥n')
        ),
        e(Content, {style:{padding:24}, role:'main'}, renderContent())
      )
    ),

    // Modal: Nueva Integraci√≥n
    e(Modal, {title:'Nueva Integraci√≥n', open:modalOpen==='new', onCancel:closeModal, footer:null, width:480},
      e(Space, {direction:'vertical', style:{width:'100%'}, size:12},
        [{key:'api-key',icon:KeyOutlined,color:'#1867FF',title:'API Key',desc:'Acceso program√°tico'},{key:'webhook-out',icon:ShareAltOutlined,color:'#52c41a',title:'Webhook Saliente',desc:'Enviar eventos'},{key:'webhook-in',icon:ApiOutlined,color:'#722ed1',title:'Webhook Entrante',desc:'Recibir datos'}].map(function(i){
          return e('div', {key:i.key, onClick:function(){setModalOpen(i.key);resetForms();}, style:{display:'flex',alignItems:'center',padding:16,border:'1px solid #d9d9d9',borderRadius:8,cursor:'pointer'}, role:'button', tabIndex:0, 'aria-label':'Crear ' + i.title},
            e('div', {style:{width:40,height:40,background:i.color+'20',borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center',color:i.color}, 'aria-hidden':'true'}, e(i.icon)),
            e('div', {style:{marginLeft:16}}, e(Text, {strong:true}, i.title), e('br'), e(Text, {type:'secondary'}, i.desc))
          );
        })
      )
    ),

    // Modal: Nueva API Key (FIX #3: ARIA labels, FIX #4: Loading)
    e(Modal, {title:'Nueva API Key', open:modalOpen==='api-key', onCancel:closeModal, onOk:handleCreateApiKey, okText: creating ? e(Space, null, e(LoadingOutlined), 'Creando...') : 'Crear', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:520},
      e(Form, {form:apiKeyForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}, {min:3, message:'M√≠nimo 3 caracteres'}]}, 
          e(Input, {placeholder:'ej: Dashboard Power BI', 'aria-label':'Nombre de la API Key', id:'apikey-name'})),
        e(Form.Item, {name:'permissions', label:'Permisos', rules:[{required:true, message:'Selecciona al menos un permiso'}]}, 
          e(Checkbox.Group, {options:['Leer unidades','Leer posiciones','Leer eventos','Leer historial','Enviar comandos'], 'aria-label':'Permisos de la API Key'})),
        e(Form.Item, {name:'accessType', label:'Acceso a unidades', initialValue:'all'}, 
          e(Select, {value:accessType, onChange:function(v){setAccessType(v);apiKeyForm.setFieldValue('accessType',v);}, options:[{value:'all',label:'Todas las unidades'},{value:'group',label:'Grupo espec√≠fico...'},{value:'units',label:'Unidades espec√≠ficas...'}], 'aria-label':'Tipo de acceso a unidades'})),
        accessType === 'group' && e(Form.Item, {name:'group', label:'Seleccionar grupo', rules:[{required:true, message:'Selecciona un grupo'}]}, 
          e(Select, {placeholder:'Elige un grupo', options:mockGroups, 'aria-label':'Seleccionar grupo'})),
        accessType === 'units' && e(Form.Item, {name:'units', label:'Seleccionar unidades', rules:[{required:true, message:'Selecciona al menos una unidad'}]}, 
          e(Select, {mode:'multiple', placeholder:'Elige unidades', options:mockUnits, 'aria-label':'Seleccionar unidades'})),
        e(Form.Item, {name:'expiration', label:'Expiraci√≥n', initialValue:'never'}, 
          e(Select, {options:[{value:'never',label:'Sin expiraci√≥n'},{value:'30d',label:'30 d√≠as'},{value:'90d',label:'90 d√≠as'},{value:'1y',label:'1 a√±o'}], 'aria-label':'Expiraci√≥n de la API Key'}))
      )
    ),

    // Modal: Editar API Key
    e(Modal, {title:'Editar API Key', open:modalOpen==='edit-api-key', onCancel:closeModal, onOk:handleEditApiKey, okText: creating ? e(Space, null, e(LoadingOutlined), 'Guardando...') : 'Guardar', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:520},
      e(Form, {form:editApiKeyForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}]}, 
          e(Input, {'aria-label':'Nombre de la API Key'})),
        e(Form.Item, {name:'accessType', label:'Acceso a unidades'}, 
          e(Select, {value:accessType, onChange:function(v){setAccessType(v);editApiKeyForm.setFieldValue('accessType',v);}, options:[{value:'all',label:'Todas'},{value:'group',label:'Grupo espec√≠fico...'}], 'aria-label':'Tipo de acceso'})),
        accessType === 'group' && e(Form.Item, {name:'group', label:'Grupo', rules:[{required:true, message:'Selecciona un grupo'}]}, 
          e(Select, {options:mockGroups, 'aria-label':'Seleccionar grupo'}))
      )
    ),

    // Modal: Nuevo Webhook Out (FIX #3 y #4)
    e(Modal, {title:'Nuevo Webhook Saliente', open:modalOpen==='webhook-out', onCancel:closeModal, onOk:handleCreateWebhookOut, okText: creating ? e(Space, null, e(LoadingOutlined), 'Creando...') : 'Crear', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:560},
      e(Form, {form:webhookOutForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}, {min:3, message:'M√≠nimo 3 caracteres'}]}, 
          e(Input, {placeholder:'ej: Alertas ‚Üí Slack', 'aria-label':'Nombre del webhook'})),
        e(Form.Item, {name:'url', label:'URL (HTTPS)', rules:[{required:true, message:'La URL es obligatoria'}, {validator:validateHttps}]}, 
          e(Input, {placeholder:'https://...', 'aria-label':'URL de destino del webhook'})),
        e(Form.Item, {name:'events', label:'Eventos', rules:[{required:true, message:'Selecciona al menos un evento'}]}, 
          e(Checkbox.Group, {options:['position_update','panic_button','speeding','zone_entry','zone_exit','ignition_change'], 'aria-label':'Eventos a enviar'})),
        e(Form.Item, {name:'filterType', label:'Filtrar unidades', initialValue:'all'}, 
          e(Select, {value:filterType, onChange:function(v){setFilterType(v);webhookOutForm.setFieldValue('filterType',v);}, options:[{value:'all',label:'Todas las unidades'},{value:'group',label:'Grupo espec√≠fico...'}], 'aria-label':'Filtro de unidades'})),
        filterType === 'group' && e(Form.Item, {name:'group', label:'Seleccionar grupo', rules:[{required:true, message:'Selecciona un grupo'}]}, 
          e(Select, {placeholder:'Elige un grupo', options:mockGroups, 'aria-label':'Seleccionar grupo'})),
        e(Divider),
        e(Form.Item, {name:'hmac', label:'Seguridad', valuePropName:'checked', initialValue:true}, 
          e(Checkbox, {'aria-label':'Habilitar firma HMAC'}, 'Habilitar firma HMAC-SHA256')),
        e(Form.Item, {name:'retries', label:'Reintentos', initialValue:'3'}, 
          e(Select, {style:{width:200}, options:[{value:'0',label:'Sin reintentos'},{value:'3',label:'3 reintentos'},{value:'5',label:'5 reintentos'}], 'aria-label':'Pol√≠tica de reintentos'}))
      )
    ),

    // Modal: Editar Webhook Out
    e(Modal, {title:'Editar Webhook', open:modalOpen==='edit-webhook-out', onCancel:closeModal, onOk:handleEditWebhookOut, okText: creating ? e(Space, null, e(LoadingOutlined), 'Guardando...') : 'Guardar', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:560},
      e(Form, {form:editWhOutForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}]}, 
          e(Input, {'aria-label':'Nombre del webhook'})),
        e(Form.Item, {name:'url', label:'URL', rules:[{required:true, message:'La URL es obligatoria'}, {validator:validateHttps}]}, 
          e(Input, {'aria-label':'URL del webhook'})),
        e(Form.Item, {name:'filterType', label:'Filtrar unidades'}, 
          e(Select, {value:filterType, onChange:function(v){setFilterType(v);editWhOutForm.setFieldValue('filterType',v);}, options:[{value:'all',label:'Todas'},{value:'group',label:'Grupo espec√≠fico...'}], 'aria-label':'Filtro de unidades'})),
        filterType === 'group' && e(Form.Item, {name:'group', label:'Grupo', rules:[{required:true, message:'Selecciona un grupo'}]}, 
          e(Select, {options:mockGroups, 'aria-label':'Seleccionar grupo'}))
      )
    ),

    // Modal: Probar Webhook
    e(Modal, {title:'Probar Webhook', open:modalOpen==='test-webhook', onCancel:function(){setModalOpen(null);setTestResult(null);}, footer:[
      e(Button, {key:'cancel', onClick:function(){setModalOpen(null);}, 'aria-label':'Cerrar modal'}, 'Cerrar'),
      e(Button, {key:'send', type:'primary', icon:e(testing ? LoadingOutlined : SendOutlined), loading:testing, onClick:function(){
        setTesting(true);
        setTimeout(function(){
          setTesting(false);
          setTestResult({ok:Math.random()>0.2, status:Math.random()>0.2?200:500, time:Math.floor(Math.random()*500)+'ms'});
        }, 1500);
      }, 'aria-label':'Enviar test'}, testing ? 'Enviando...' : 'Enviar Test')
    ], width:600},
      testWh && e('div', null,
        e(Text, {strong:true}, 'Endpoint: '), e('code', null, testWh.url),
        e(Divider),
        e(Text, {strong:true}, 'Payload de prueba:'),
        e('pre', {className:'code-block', style:{marginTop:8}, 'aria-label':'Payload JSON de prueba'}, JSON.stringify({id:'test_'+Date.now(),type:'panic_button',unit:{id:'TRK-001',name:'Volvo FH'},location:{lat:19.4326,lng:-99.1332},timestamp:new Date().toISOString()}, null, 2)),
        testResult && e('div', {style:{marginTop:16}, role:'alert'},
          testResult.ok 
            ? e(Result, {status:'success', title:'Webhook entregado', subTitle:'Status: '+testResult.status+' ‚Ä¢ Latencia: '+testResult.time})
            : e(Result, {status:'error', title:'Error', subTitle:'Status: '+testResult.status})
        )
      )
    ),

    // Modal: Nuevo Webhook In (FIX #3 y #4)
    e(Modal, {title:'Nuevo Webhook Entrante', open:modalOpen==='webhook-in', onCancel:closeModal, onOk:handleCreateWebhookIn, okText: creating ? e(Space, null, e(LoadingOutlined), 'Creando...') : 'Crear', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:520},
      e(Form, {form:webhookInForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}, {min:3, message:'M√≠nimo 3 caracteres'}]}, 
          e(Input, {placeholder:'ej: √ìrdenes de SAP', 'aria-label':'Nombre del endpoint'})),
        e(Form.Item, {name:'dataType', label:'Tipo de datos', initialValue:'orders', rules:[{required:true}]}, 
          e(Select, {options:[{value:'orders',label:'√ìrdenes de entrega'},{value:'routes',label:'Rutas'},{value:'drivers',label:'Conductores'},{value:'custom',label:'Custom JSON'}], 'aria-label':'Tipo de datos a recibir'})),
        e(Form.Item, {name:'linkBy', label:'Vincular por', initialValue:'plate', rules:[{required:true}]}, 
          e(Select, {options:[{value:'plate',label:'Placa'},{value:'id',label:'ID unidad'},{value:'economic',label:'N√∫mero econ√≥mico'}], 'aria-label':'Campo para vincular con unidades'})),
        e(Alert, {message:'Se generar√° un endpoint y secreto HMAC √∫nicos.', type:'info', showIcon:true})
      )
    ),

    // Modal: Editar Webhook In
    e(Modal, {title:'Editar Endpoint', open:modalOpen==='edit-webhook-in', onCancel:closeModal, onOk:handleEditWebhookIn, okText: creating ? e(Space, null, e(LoadingOutlined), 'Guardando...') : 'Guardar', okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:520},
      e(Form, {form:editWhInForm, layout:'vertical'},
        e(Form.Item, {name:'name', label:'Nombre', rules:[{required:true, message:'El nombre es obligatorio'}]}, 
          e(Input, {'aria-label':'Nombre del endpoint'})),
        e(Form.Item, {name:'linkBy', label:'Vincular por', rules:[{required:true}]}, 
          e(Select, {options:[{value:'plate',label:'Placa'},{value:'id',label:'ID unidad'}], 'aria-label':'Campo para vincular'}))
      )
    ),

    // Modal: Conexi√≥n externa
    e(Modal, {title:connModal ? (connModal.connected ? 'Configurar ' : 'Conectar ') + connModal.name : '', open:!!connModal, onCancel:function(){setConnModal(null);}, onOk:handleConnection, okText: creating ? e(Space, null, e(LoadingOutlined), (connModal && connModal.connected ? 'Guardando...' : 'Conectando...')) : (connModal && connModal.connected ? 'Guardar' : 'Conectar'), okButtonProps:{disabled:creating, loading:creating}, cancelButtonProps:{disabled:creating}, width:480},
      connModal && e('div', null,
        connModal.connected 
          ? e(Form, {form:connForm, layout:'vertical'},
              e(Alert, {message:'Conexi√≥n activa', type:'success', showIcon:true, style:{marginBottom:16}}),
              e(Form.Item, {name:'channel', label:'Canal de Slack', rules:[{required:true, message:'Ingresa el canal'}], initialValue:'#alertas-flota'}, 
                e(Input, {placeholder:'#canal', 'aria-label':'Canal de Slack'})),
              e(Form.Item, {name:'events', label:'Notificar eventos', rules:[{required:true, message:'Selecciona al menos un evento'}]}, 
                e(Checkbox.Group, {defaultValue:['panic_button'], options:['panic_button','speeding','zone_exit'], 'aria-label':'Eventos a notificar'}))
            )
          : e('div', null,
              e(Paragraph, null, 'Ser√°s redirigido a ', e(Text, {strong:true}, connModal.name), ' para autorizar la conexi√≥n.'),
              e(Alert, {message:'Permisos requeridos: Enviar mensajes a canales', type:'info', showIcon:true})
            )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>
</body>
</html>
